---
import { getCollection, getEntry } from 'astro:content';
import { Image } from 'astro:assets';
import Layout from '@layouts/Layout.astro';
import Text from '@components/Text.astro';
import Panel from '@components/Panel.astro';
import HeroImage from '@components/HeroImage.astro';
import SingleCourseMap from '@components/SingleCourseMap.astro';

export async function getStaticPaths() {
  const courses = await getCollection('courses');
  return courses.map((course) => ({
    params: { slug: course.slug },
    props: { course },
  }));
}

const { course } = Astro.props;
const { Content } = await course.render();

// Get disc library if referenced
const discLibrary = course.data.discLibrary ? await getEntry(course.data.discLibrary) : null;

// Parse location coordinates (mandatory)
if (!course.data.location) {
  throw new Error(`Course ${course.slug} is missing required location data`);
}
const parsed = JSON.parse(course.data.location);
const lat = parsed.coordinates[1];
const lng = parsed.coordinates[0];

// Generate map links
const mapLinks = {
  google: course.data.googleMapsUrl || `https://www.google.com/maps/search/?api=1&query=${lat},${lng}`,
  apple: `https://maps.apple.com/?q=${encodeURIComponent(course.data.title)}&ll=${lat},${lng}`
};
---

<Layout
  title={course.data.title}
  subtitle={course.data.suburb}
  collectionName="courses"
  entrySlug={course.slug}
>
  {course.data.mainImage && (
    <HeroImage
      src={course.data.mainImage}
      alt={course.data.title}
      class="aspect-2/1"
    />
  )}

  <Text>

    <Content />

    <section>
      <h2>Location</h2>
      <SingleCourseMap lat={lat} lng={lng} title={course.data.title} />
      <p>
        View in:
        <a href={mapLinks.google} target="_blank" rel="noopener noreferrer">Google Maps</a>
        {' Â· '}
        <a href={mapLinks.apple} target="_blank" rel="noopener noreferrer">Apple Maps</a>
      </p>
    </section>

    {discLibrary && (
      <section>
        <h2>Nearest disc library</h2>
        <p>If you don't have your own discs, you can borrow some from <a href={discLibrary.data.url}>{discLibrary.data.location}</a>.</p>
      </section>
    )}

    {course.data.courseMap && (
      <section>
        <h2>Course map</h2>
        <a href={course.data.courseMap.src}>
          <Image
            src={course.data.courseMap}
            alt={`${course.data.title} course map`}
            class="w-full rounded-lg cursor-pointer hover:opacity-90 transition-opacity"
            inferSize={true}
          />
        </a>
      </section>
    )}

  </Text>

</Layout>
